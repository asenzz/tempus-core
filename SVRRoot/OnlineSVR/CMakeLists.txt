CMAKE_MINIMUM_REQUIRED(VERSION 3.10)
IF(USE_CUDA)
	PROJECT(OnlineSVR LANGUAGES CXX CUDA)
    FIND_PACKAGE(CUDA REQUIRED)
    LINK_LIBRARIES(${CUDA_CUBLAS_LIBRARIES} ${CUDA_cusolver_LIBRARY} ${CUDA_cufft_LIBRARY})
ELSE()
	PROJECT(OnlineSVR CXX)
ENDIF()

SET(DEPENDENCIES SVRCommon SVRModel)
FOREACH(DEP ${DEPENDENCIES})
    INCLUDE_DIRECTORIES(../${DEP}/include)
ENDFOREACH(DEP)

FILE(GLOB SOURCE_FILES "src/*.c" "src/*.cpp" "include/*.h" "include/*.hpp" "include/*.tcc")
IF(USE_CUDA)
    FILE(GLOB SOURCE_FILES_CUDA "src/*.cpp" "include/*.h" "include/*.hpp" "include/*.tcc" "src/*.cu" "src/*.cuh")
    LIST(APPEND SOURCE_FILES ${SOURCE_FILES_CUDA})
ENDIF()

FIND_PACKAGE(Boost ${Boost_MIN_VERSION} COMPONENTS thread system REQUIRED)

IF (EXPERIMENTAL_FEATURES)
    #FIND_PACKAGE(OSQP REQUIRED)
    #FIND_PACKAGE(Eigen3 REQUIRED)
    LINK_DIRECTORIES(${MATLAB_LINK_DIR} "/usr/lib/google/tensorflow")
    EXECUTE_PROCESS(COMMAND python3-config --includes OUTPUT_STRIP_TRAILING_WHITESPACE OUTPUT_VARIABLE PYINCLUDES)
    STRING(REGEX REPLACE "[\n ]" "" PYINCLUDES "${PYINCLUDES}")
    FIND_PACKAGE(Python3 REQUIRED)
    INCLUDE_DIRECTORIES("${MATLAB_INCLUDE_DIR}" "${PYINCLUDES}" "/usr/include/python3.6m") # "/usr/local/include/eigen3" "/usr/local/include/google/protobuf"
    #FIND_PACKAGE(Torch REQUIRED)
ENDIF(EXPERIMENTAL_FEATURES)

LINK_LIBRARIES(${DEPENDENCIES} ${JEMALLOC_LIBRARIES} magma armadillo ${OMP_LIBRARY} TBB::tbb)
IF(EXPERIMENTAL_FEATURES)
    LINK_LIBRARIES(fftw3 MatlabDataArray MatlabEngine python3.6m) # osqp::osqpstatic clblast tensorflow_all ${TORCH_LIBRARIES}
    SET(TEST_DEPENDENCIES ${PROJECT_NAME} SVRBusiness SVRCommon SVRModel wavelib fftw3 python3.6m) # tensorflow_all ${TORCH_LIBRARIES}
ELSE()
    SET(TEST_DEPENDENCIES ${PROJECT_NAME} SVRBusiness SVRCommon SVRModel wavelib fftw3)
ENDIF()

IF(WITH_TESTS AND PROJECT_NAME MATCHES "${WITH_TESTS}")
    MESSAGE("~~ Building ${PROJECT_NAME}-test")

    SET_PROPERTY(DIRECTORY PROPERTY TEST_MODULES "${PROJECT_NAME}")

    SET(GTEST_ROOT "/usr")

    FIND_PACKAGE(GTest REQUIRED)
    FIND_PACKAGE(Boost ${Boost_MIN_VERSION} COMPONENTS program_options REQUIRED)
    INCLUDE_DIRECTORIES(${GTEST_ROOT}/include)

    LINK_DIRECTORIES(${GTEST_ROOT}/lib)

    FILE(GLOB TEST_SOURCE_FILES "test/*.cpp")
    ADD_EXECUTABLE(${PROJECT_NAME}-test ${TEST_SOURCE_FILES})
    TARGET_LINK_LIBRARIES(${PROJECT_NAME}-test ${JEMALLOC_LIBRARIES} ${DEPENDENCIES} ${TEST_DEPENDENCIES} gtest gtest_main pthread ${Boost_LIBRARIES})
endif()


ADD_DEFINITIONS(-DARMA_ALLOW_FAKE_GCC)

ADD_LIBRARY(${PROJECT_NAME} ${LIBS_BUILD_TYPE} ${SOURCE_FILES})
